# TRDATA Market Data Platform API

Powered by TRDATA Tech team. 

## Changelog

-  **v0.1 from 23.11.2021**
	-  Public API scheme

## Введение

Ограничение на количество запросов: 100 запросов в секунду. 

Система доступна по HTTPS и WebSocket (WebSocket Secure). 

На текущий момент доступно две платформы: 

- **Production** (REST) - https://api.mdp.trdatatech.com/ 
- **Production** (WebSocket) - wss://api.mdp.trdatatech.com/ws
- ***Dev release*** (dev, REST) - https://devapi.mdp.trdatatech.com/*
- ***Dev release*** (dev, WebSocket,) - wss://devapi.mdp.trdatatech.com/ws*

Важно! Стабильность работы и совместимость между платформами Dev и Prod НЕ ГАРАНТИРУЕТСЯ. 

Production сервис настроен на автоматический перезапуск при возникновении критических ошибок, поэтому если вы получили HTTP ошибку или соединение WebSocket разорвано, просто повторите подключение через 5 секунд (сервис перезагружается через 1 секунду, однако стартовая инициализация может занять некоторое время). 

Для HTTP-REST интерфейса поддерживается HTTP 1.1 и HTTP 2.0, ответ сервера сжимается gzip-ом (если клиент заявил о поддержке). Для режима WebSocket поддерживается расширение permessage-deflate, версия протокола - 13. 

Все сообщения (в обоих протоколах) пересылаются в формате JSON. 

#### Стандартный формат ответа сервера (успешный ответ, REST):

```javascript
{
	code: 200,
	status: "ok",
	method: "get",
	data: {
		//any response data
	}
}
```

#### Ответ сервера в случае ошибки (REST):

```javascript
{
	code: 10042,	//Integer code of error (currently has no standart for this)
	status: "error",	//always "error" 
	message: "Unknown method"	//Message, described whats are goined wrong
    method: "get", //code of requested action
    data: null //or debug/trace data
}
```

Для HTTP-REST протокола параметры задаются через HTTP-параметры (GET-метод).

Для WebSocket-а форматы аналогичны, с несколькими дополнениями.

#### WS Request

```javascript
{	
	method: "subscribe", //Method, only supporting get|subscribe|unsubscribe|list 
	version: "v1",	//Protocol version, always "v1" at now
	actions: [	//Array of individual commands: [<command>, {Params object}]
			['heartbeat'],
			['quote', {symbol:'.AAPL'}]
	]
}
```

#### WS Response

```javascript
{
	code: 200,
    status: "ok", //Status of execution, ok|error. For error, in addition, we adding code and message fields.
    id: 2, 	//Integer, sequence counter of command execution
	method: "subscribe", //executed command
	data: {
		//any response data
	}
}
```

Ответ WebSocket-а в случае ошибки аналогичен REST-протоколу. Если ошибка незначительная, соединение остается открытым, если продолжить работу невозможно, соединение будет принудительно закрыто на стороне сервера. 

#### Общие моменты 

MDP - это реалтайм платформа для сбора, агрегации, хранения и передачи рыночных данных. Базовый функционал платформы - получение последних котировок по одному или нескольким инструментам, подписка на постоянное обновление одного или нескольких инструментов, а также получение расширенной информации по инструменту и доступ к историческим данным. 

MDP использует концепцию подписок (Subscribe) и RFQ (однократное получение котировки). Также есть служебные функции поиска и получения списка инструментов, доступных для подписки. 

Подписка - это указание сервису, что клиент хочет в дальнейшем постоянно получать котировки по одному или нескольким инструментам, до момента, когда он явно не отменит подписку. Разрыв соединения или переподключение НЕ приводит к сбросу подписок, однако клиент потеряет пропущенные данные, а после подключения начнет получать актуальные рыночные данные с момента последнего подключения. 

На сейчас режим инкрементного обновления не поддерживаеться (запланировано в версии v2). 

#### Идентификаторы инструментов

Ключевой момент - идентификатор инструмента должен содержать указание и на источник и указывать на конкретный инструмент внутри источника. MDP работает с агрегацией из множества источников, включая, но не ограничиваясь биржами и top-level data providers. 

На текущий момент мы поддерживаем следующие типы (классы) инструментов: 

- **FX** (валютные пары, например, USD/UAH)
- **Stocks** (акции, например, AAPL)
- **Bonds** (облигации, например, US345370CV02)
- Другие типы инструментов будут подключаться по запросу в следующих версиях

Каждый источник данных имеет, зачастую, собственную идентификацию инструментов и они несовместимы между собой. Поэтому мы используем два уровня идентификации: запрос унифицированной котировки через общий идентификатор, или получение индивидуальной котировки от конкретного источника. 

Источник данных обозначаеться 3-х буквенным префиксом в идентификаторе инструмента и отделяеться от кода инструмента символом двоеточия ":" Можно опускать код источника, тогда символ начинаеться с точки (например, .AAPL)

- TRDATA - **TRD**
- US markets - **USA**
- UX (Украинская биржа) - **UXX**
- PFTS (Биржа ПФТС) - **PFS**
- Перспектива - **PST**
- FX Global Data (данные по валютам могут быть сведены из множества источников) - **FXX**
- Reference aggregated data - **REF** (общие агрегированные данные, дефолтные) - или опускать вообще.

Если нужны просто последние данные, агрегированные  - используйте дефолтный источник: REF (если в идентификаторе будет опущен код источника, это равноценно REF. То есть, подписка на REF.AAPL идентична подписке .AAPL)

#### Формат данных о котировке

Котировка - главный кирпичик данных, которые передаються платформой. С одной стороны, мы подключаемся к большому количеству источников данных, используя разные протоколы и форматы данных, с друго - отдаем сведенный и очищенный дата-фид, приводя все котировки в один формат. 

Ключевые поля данных:

- id - уникальный ид конкретно этой котировки в формате UUIDv4
- Symbol или глобальный идентификатор инструмента
- Datetime актуальности котировки (GMT/UTC+0)
- Биржа или источник данных
- Тип инструмента (акции, валюта и т.п.)
- Bid / Ask / Price - цены, лучшая цена покупки, лучшая цена продажи и последняя сделка. В ряде случаев, вместо последней сделки может быть среднее (mid price) между Bid и Ask. В других случаях, наоборот, есть только Price, тогда все три поля будут иметь одинаковое значение.
- ИД внутри источника - внутренний идентификатор внутри непосредственно источника данных.
- _raw - специальное отладочное поле, которое может принимать значение обьекта, например, сырой формат данных от источника для отладки

```json
{
    id: "af703acc-155b-4293-940d-353b39b8f78b",
    symbol: "REF.AAPL",
    datetime: "2021-12-01T19:28:39.506Z",
    source: "USA",
    type: "STOCK",
    bid: 101.99,
    ask: 102.03,
    price: 102.01,
    qid: "US0378331005", //или к примеру, NASDAQ:AAPL
    _raw: null
}
```

**Важно**: это текущий драфт и он может быть скорректирован в сторону увеличения количества полей. Обратная совместимость в приоритете, но не гарантируеться.

#### Current limitation

- Поддерживаемые биржи:
  - USA markets (<list of exchanges)
  - UX
  - PFTS
  - ФБ Перспектива
  - TRDATA (агреггированный источник)



#### Endpoints для работы с данными 

- /symbols/list - текущий список котировок, на которые мы подписаны
- /symbols/find - поиск нужного инструмента по всем источникам (**важно**: может быть долгим)
- /symbols/subscribe - подписка на получение одного или нескольких инструментов (будут добавлены в subscribelist)
- /symbols/unsubscribe - отмена подписки на инструмент
- /symbols/get - однократное получение котировки по одному или нескольким инструментам
- /symbols/latest - однократное получение всех актуальных данных по текущему списку подписки
- /symbols/historical - получение исторических данных по указанному инструменту
- /symbols/ids - служебный метод, возвращает для указанного общего идентификатора список конкретных биржевых
- /source/symbols - если поддерживаеться, список котировок с конкретного источника 







## REST Endpoints

### version

Возвращает актуадьную версию API-сервера (версия сервера + хеш версии). Для dev-версии изменяеться хеш, продакшин версия полностью (релиз и хеш).

#### Request

​	https://api.mdp.trdatatech.com/api/v1/version 

#### Params

​	Нет параметров

#### Response

```javascript
{
	code: 200,
    status: "ok",
	data: {
		version: "v0.4.1-a738be44"
	}
}
```



### time

Возвращает текущее серверное время в формате ISO. Таймзона - UTC (GMT+0).

#### Request

​	https://api.mdp.trdatatech.com/api/v1/time 

#### Params

​	Нет параметров

#### Response

```javascript
{
	code: 200,
    status: "ok",
	data: {
		time: "2021-03-15T19:28:39.506Z"
	}
}
```



### heartbeat

Базовая проверка соединения и работоспособности сервера.

#### Request

​	https://api.mdp.trdatatech.com/api/v1/heartbeat 

#### Params

​	Нет параметров

#### Response

```javascript
{
	code: 200,
    status: "ok",
	data: {}
}
```



### status

Возвращает расширенный статус всех сервисов

#### Request

​	https://api.mdp.trdatatech.com/api/v1/status 

#### Params

​	Нет параметров

#### Response

```javascript
{
	code: 200,
    status: "ok",
	data: {
		maindb: "online",	//Status of main storage
		pubsub: "online",	//Status of internal mq sub-system
		time: "2021-03-15T19:34:57.770Z",	//Current server time in ISO format
		instrumenterMonitor: "online",
		marketdataPFTS: "online",	//connector status
		marketdataUX: "online",	//connector status
		marketdataUS: "online",	//connector status
		marketdataTRDATA: "online",	//connector status
		apiServer: "online"	//API service
    }
}
```



### exchanges

Возвращает общую информацю о биржах, с которыми мы работает (или будем работать) 

#### Request

​	https://api.mdp.trdatatech.com/api/v1/exchanges

#### Params

​	Нет параметров

#### Response	

```javascript
{
    code: 200,
    status: "ok",
    data: {
        "trdata": {},
        "usa": {},
        "ux": {},
        "pfts": {},
        "perspectiva": {},
        "opyn": {}
    }
}
```



## WebSocket

Для работы доступно три метода:

- **get** - однократное получение результата (аналог REST-запроса)
- **subscribe** - постоянное получение обновлений. Первым идет снапшот текущего состояния, в дальнейшем - обновленный вариант. Важно - Incremental updates не поддерживаются сейчас.
- **unsubscribe** - прекращает подписку. Никакого ответа не предусмотрено (или стандартный пустой ответ).

В рамках одного запроса можно совершить только один метод, но в качестве параметра можно передать множество отдельных команд. Все они будут выполнены в той же очередности, как указаны в запросе. Ответы будут индивидуально на каждый запрос. 

Частота обновлений (команда subscribe) зависит от метода. 

#### Limitation

Размер одного запроса (списка команд) желательно ограничить ~ 100Kb

Максимальный размер ответа сервера (одного ответа) - 2 Mb. 

Параметры всех запросов идентичны REST-методам

В ряде методов для подписки, вместо параметра symbol допускается использовать '*' как паттерн. Однако будьте внимательны, это может очень нагрузить клиент и сервер, так как количество обновлений и размер данных может быть очень большим (теоретически, до нескольких сотен сообщений в секунду). 
